# ‚úÖ TBank Connector - –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑ –¢–ë–∞–Ω–∫–∞ (Tinkoff Business) –≤ YNAB —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω!

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. ‚úÖ TBank API Client (`src/clients/tbank.ts`)
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç–æ–≤ (—Ä—É–±–ª–µ–≤—ã–µ, –¥–æ–ª–ª–∞—Ä–æ–≤—ã–µ, —Ñ—É–Ω—Ç–æ–≤—ã–µ)
- –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã–ø–∏—Å–∫–∏ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º –∑–∞ –ø–µ—Ä–∏–æ–¥
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –≤—ã–ø–∏—Å–æ–∫ (–¥–æ 5000 –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Ä–∞–∑)
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—É–º–º –≤ YNAB milliunits
- –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è YNAB
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ payee –∏–∑ merchant/counterparty
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö import_id

### 2. ‚úÖ TBank Sync Service (`src/services/tbankSync.ts`)
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π TBank ‚Üí YNAB
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è RUB ‚Üí USD** —á–µ—Ä–µ–∑ –∫—É—Ä—Å—ã –≤ Supabase (RUB ‚Üí EUR ‚Üí USD)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ–±–µ—Ç–æ–≤—ã—Ö –∏ –∫—Ä–µ–¥–∏—Ç–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ import_id
- –ú–∞–ø–ø–∏–Ω–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ Supabase

### 3. ‚úÖ Currency Conversion (`src/services/currency.ts`)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `convertRubToUsd()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫—É—Ä—Å—ã EUR/RUB –∏ EUR/USD –∏–∑ Supabase
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ü–µ–ø–æ—á–∫—É: RUB ‚Üí EUR ‚Üí USD

### 4. ‚úÖ Supabase Integration (`src/clients/supabase.ts`)
- –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞–ø–ø–∏–Ω–≥–æ–º TBank —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
  - `createTbankMapping()` - —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞
  - `getTbankMapping()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞
  - `getTbankMappingsByAccount()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤ –ø–æ —Å—á–µ—Ç—É
  - `updateTbankMappingStatus()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  - `updateTbankMappingYnabId()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ YNAB ID

### 5. ‚úÖ Database Schema (`create_tbank_table.sql`)
- SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `tbank_transaction_mappings`
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- Trigger –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `updated_at`

### 6. ‚úÖ Test Script (`src/test-tbank.ts`)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ TBank API
- –í—ã–≤–æ–¥ —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç–æ–≤ —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è YNAB

### 7. ‚úÖ Configuration
- –î–æ–±–∞–≤–ª–µ–Ω `TBANK_TOKEN` –≤ `env.template`
- –ù–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±—é–¥–∂–µ—Ç –∏ –∞–∫–∫–∞—É–Ω—Ç:
  - Budget ID: `9c2dd1ba-36c2-4cb9-9428-6882160a155a`
  - Account ID: `d92d652a-a66b-4081-93ff-f8b46fe49248`
- –†—É–±–ª–µ–≤—ã–π —Å—á–µ—Ç: `40802810300000990185`

### 8. ‚úÖ Documentation (`TBANK_SETUP.md`)
- –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- –ü–æ–ª—É—á–µ–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞ –¢–ë–∞–Ω–∫–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IP –∞–¥—Ä–µ—Å–∞ –¥–ª—è —Ç–æ–∫–µ–Ω–∞
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ Supabase
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- Troubleshooting

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
- API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü–æ–ª—É—á–µ–Ω—ã 3 —Å—á–µ—Ç–∞ (RUB, USD, GBP)
- –ü–æ–ª—É—á–µ–Ω–∞ 1 –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- –ë–∞–ª–∞–Ω—Å: 402,236.35 ‚ÇΩ

### üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ Supabase**:
   ```bash
   # –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –≤ Supabase SQL Editor
   cat create_tbank_table.sql
   ```

2. **–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –µ—Å—Ç—å –≤ Supabase**:
   - EUR/USD –≤ —Ç–∞–±–ª–∏—Ü–µ `exchange_rates`
   - EUR/RUB –≤ —Ç–∞–±–ª–∏—Ü–µ `exchange_rates`

3. **–î–æ–±–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π sync** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```typescript
   // –í src/services/sync.ts
   import { syncTbankToYnab } from './tbankSync.js';
   
   // –í —Ñ—É–Ω–∫—Ü–∏–∏ performSync():
   const tbankStats = await syncTbankToYnab();
   ```

4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**:
   ```bash
   # –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π sync
   npm run sync-once
   ```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
YNAB_sync_app/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ clients/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tbank.ts          # ‚úÖ TBank API client
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts        # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω (TBank –º–µ—Ç–æ–¥—ã)
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tbankSync.ts       # ‚úÖ TBank sync service
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ currency.ts        # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω (convertRubToUsd)
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω (tbankToken)
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts           # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω (tbankToken)
‚îÇ   ‚îî‚îÄ‚îÄ test-tbank.ts          # ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ create_tbank_table.sql     # ‚úÖ SQL –¥–ª—è Supabase
‚îú‚îÄ‚îÄ TBANK_SETUP.md             # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
‚îú‚îÄ‚îÄ TBANK_README.md            # ‚úÖ –≠—Ç–æ —Ñ–∞–π–ª
‚îî‚îÄ‚îÄ env.template               # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω (TBANK_TOKEN)
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –¢–ë–∞–Ω–∫–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ .env
echo "TBANK_TOKEN=your_token_here" >> .env

# 2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ Supabase
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ create_tbank_table.sql –≤ Supabase SQL Editor

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
npm run test-tbank

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
npm run sync-once
```

## üí° –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –û–ø–µ—Ä–∞—Ü–∏—è –∏–∑ TBank:
```json
{
  "operationId": "51f7ec21-048f-0006-ba03-87d70a9e14e3",
  "operationDate": "2026-01-03T14:05:51Z",
  "accountAmount": 8990.0,
  "accountCurrencyDigitalCode": "643", // RUB
  "typeOfOperation": "Debit",
  "description": "–û–ø–ª–∞—Ç–∞ –≤ RK*finologru G.Moskva RUS",
  "merch": {
    "name": "RK*finologru",
    "city": "G.Moskva",
    "country": "RUS"
  }
}
```

### –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ YNAB:
```typescript
{
  account_id: "d92d652a-a66b-4081-93ff-f8b46fe49248",
  date: "2026-01-03",
  amount: -90230, // -90.23 USD (8990 RUB ‚Üí USD –ø–æ –∫—É—Ä—Å—É)
  payee_name: "RK*finologru",
  memo: "–û–ø–ª–∞—Ç–∞ –≤ RK*finologru G.Moskva RUS | RK*finologru, G.Moskva, RUS | Card: 220070******8517",
  cleared: "cleared",
  approved: false,
  import_id: "TBANK:51f7ec21-048f-0006-ba03-87d7"
}
```

## üé® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ payee
1. –î–ª—è –∫–∞—Ä—Ç–æ—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π ‚Üí merchant name
2. –î–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ‚Üí counterparty name
3. Fallback ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è

### –î–µ—Ç–∞–ª—å–Ω–æ–µ memo
- –û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ merchant (–≥–æ—Ä–æ–¥, —Å—Ç—Ä–∞–Ω–∞)
- –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ 200 —Å–∏–º–≤–æ–ª–∞–º–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
```
8990 RUB (TBank)
‚Üí 8,990,000 milliunits
‚Üí ~86.05 EUR (–ø–æ –∫—É—Ä—Å—É 104.50)
‚Üí ~90.23 USD (–ø–æ –∫—É—Ä—Å—É 1.05)
‚Üí -90,230 milliunits (–¥–ª—è –¥–µ–±–µ—Ç–∞)
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `TBANK_SETUP.md` - —Ç–∞–º –µ—Å—Ç—å Troubleshooting
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `npm run test-tbank` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é  
**–î–∞—Ç–∞**: 2026-01-08  
**–í–µ—Ä—Å–∏—è**: 1.0.0

















