Краткое ТЗ: приложение для синхронизации займов между бюджетами YNAB (личный ↔ компании)

Цель:
Автоматически создавать “зеркальные” транзакции займа между личным бюджетом (EUR) и бюджетами компаний (USD), чтобы при внесении транзакции в одном бюджете соответствующая транзакция появлялась в другом бюджете с корректным знаком и суммой в нужной валюте. Поддержка 3 компаний.

1) Область применения

1 личный бюджет YNAB (EUR).

3 отдельных бюджета YNAB компаний (USD).

Синхронизируются только транзакции, которые идентифицируются как “займ” по payee_id.

2) Основные сценарии

Личный → Компания
Создана/изменена/удалена транзакция займа в личном бюджете → автоматически создается/обновляется/удаляется зеркальная транзакция в бюджете соответствующей компании.

Компания → Личный
Создана/изменена/удалена транзакция займа в бюджете компании → автоматически создается/обновляется/удаляется зеркальная транзакция в личном бюджете.

3) Правила зеркалирования

Знак суммы: зеркальная транзакция должна иметь противоположный знак (расход ↔ доход) согласно правилам займа.

Валюта: сумма пересчитывается EUR↔USD по курсу из Supabase.

Курс: берется из таблицы курсов по месяцу транзакции (например, YYYY-MM) и применяется для расчета зеркальной суммы.

Дата: зеркальная транзакция ставится на ту же дату, что и исходная (если не задано иное).

Описание (memo): в зеркальной транзакции фиксируется ссылка/маркер на исходную (для дебага и трассировки).

4) Идемпотентность и защита от дублей

При создании зеркальной транзакции используется стабильный import_id, вычисляемый из идентификатора исходной транзакции и бюджета-источника.

Повторная обработка одной и той же исходной транзакции не должна создавать дубликаты.

5) Определение “транзакция = займ”

Транзакция считается займом, если её payee_id входит в список “loan payees” для конкретной связки (личный↔конкретная компания).

Приложение должно поддерживать отдельные списки/маппинги payee_id для каждой компании.

6) Хранилище Supabase (минимальные требования)

Таблица курсов валют по месяцам

Поля: month (YYYY-MM), eur_usd_rate (или эквивалентная структура).

Используется для конвертации сумм.

Таблицы соответствий транзакций (3 штуки, по одной на компанию)

Каждая хранит пары соответствий: source_tx_id ↔ mirror_tx_id, а также служебные поля (даты, суммы, курс, статус синка).

Каждая таблица привязана к конкретной компании.

Состояние синхронизации

Хранение технического состояния обработчика (например, “последняя точка синка”/курсор/версия) отдельно для личного бюджета и для каждого бюджета компании.

7) Логика обработки изменений

Приложение регулярно проверяет изменения в бюджетах (личный + 3 компании).

Для каждой найденной транзакции займа:

если связи ещё нет — создать зеркальную и записать соответствие;

если связь есть — обновить зеркальную при изменении исходной;

если исходная удалена — удалить зеркальную и пометить связь как удалённую/закрытую.

